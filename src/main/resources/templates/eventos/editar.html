<!DOCTYPE html>
<html lang="pt-BR">
  <th:block
    th:replace="fragments/head :: head('Editar evento | Partiu!')"
  ></th:block>

  <body>
    <th:block th:replace="fragments/header :: header"></th:block>

    <main class="max-w-2xl mx-auto space-y-6 py-12">
      <hgroup class="space-y-3">
        <h1 class="text-center font-semibold text-2xl">Editar evento</h1>

        <p class="text-neutral-500 text-center text-balance">
          Atualize as informações do evento.
        </p>
      </hgroup>

      <form
        id="atualizar-evento"
        class="grid grid-cols-3 gap-4"
        th:action="@{'/eventos/editar/' + ${evento.id}}"
        method="POST"
        enctype="multipart/form-data"
        th:object="${evento}"
      >
        <div class="col-span-3 flex flex-col gap-1">
          <label for="nome">
            Nome
            <span class="text-red-500">*</span>
          </label>

          <input
            class="border px-3 py-1.5 rounded-md"
            type="text"
            id="nome"
            name="nome"
            placeholder="Digite o nome do evento"
            required
            th:value="*{nome}"
          />

          <p
            th:if="${#fields.hasErrors('nome')}"
            th:errors="*{nome}"
            class="text-red-500 text-sm"
          ></p>
        </div>

        <div class="col-span-3 flex flex-col gap-1">
          <label for="descricao"> Descrição </label>

          <textarea
            class="border px-3 py-1.5 rounded-md"
            id="descricao"
            name="descricao"
            placeholder="Digite a descrição"
            rows="3"
            th:text="*{descricao}"
          ></textarea>

          <p
            th:if="${#fields.hasErrors('descricao')}"
            th:errors="*{descricao}"
            class="text-red-500 text-sm"
          ></p>
        </div>

        <div class="col-span-3 flex flex-col gap-1">
          <label for="midias">Mídias (Imagens ou Vídeos)</label>

          <label
            for="midias"
            class="border border-dashed rounded-lg flex justify-center items-center h-32 cursor-pointer hover:bg-neutral-50 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-image-icon lucide-image size-12 text-neutral-400"
            >
              <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
              <circle cx="9" cy="9" r="2" />
              <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
            </svg>
          </label>

          <input
            class="border px-3 py-1.5 rounded-md"
            type="file"
            id="midias"
            name="midias"
            multiple
            accept="image/*,video/*"
            hidden
          />

          <p class="text-sm text-gray-500">
            Selecione uma ou mais imagens ou vídeos (máx. 10MB cada)
          </p>

          <input
            type="hidden"
            id="midiasParaExcluir"
            name="midiasParaExcluir"
            value=""
          />

          <div
            class="grid grid-cols-6 gap-4 mt-2.5 mb-2 empty:hidden"
            id="preview-midias"
          >
            <div
              class="border rounded-lg overflow-hidden relative"
              th:each="midia : ${evento.midias}"
              th:data-midia-id="${midia.id}"
            >
              <img
                th:src="@{${midia.url}}"
                alt="Mídia do evento"
                class="w-full h-full object-cover aspect-square"
              />

              <button
                class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600"
                type="button"
                onclick="excluirMidiaExistente(this)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="lucide lucide-x-icon lucide-x size-3"
                >
                  <path d="M18 6 6 18" />
                  <path d="m6 6 12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="col-span-3 grid grid-cols-2 gap-4">
          <div class="flex flex-col gap-1">
            <label for="categoria">
              Categoria
              <span class="text-red-500">*</span>
            </label>

            <select
              class="border px-3 py-1.5 rounded-md"
              id="categoria"
              name="categoria"
              required
            >
              <option value="">Selecione uma categoria</option>
              <option
                th:each="cat : ${categorias}"
                th:value="${cat}"
                th:text="${cat.displayName}"
                th:selected="${cat.name() == evento.categoria.name()}"
              ></option>
            </select>

            <p
              th:if="${#fields.hasErrors('categoria')}"
              th:errors="*{categoria}"
              class="text-red-500 text-sm"
            ></p>
          </div>

          <div class="flex flex-col gap-1">
            <label for="local">
              Local
              <span class="text-red-500">*</span>
            </label>

            <select
              class="border px-3 py-1.5 rounded-md"
              id="local"
              name="local"
              required
            >
              <option value="">Selecione um local</option>
              <option
                th:each="loc : ${locais}"
                th:value="${loc.id}"
                th:text="${loc.nome}"
                th:selected="${loc.id == evento.local?.id}"
              ></option>
            </select>

            <p
              th:if="${#fields.hasErrors('local')}"
              th:errors="*{local}"
              class="text-red-500 text-sm"
            ></p>
          </div>
        </div>

        <div class="col-span-3 grid grid-cols-2 gap-4">
          <div class="flex flex-col gap-1">
            <label for="dataInicio">
              Data de Início
              <span class="text-red-500">*</span>
            </label>

            <input
              class="border px-3 py-1.5 rounded-md"
              type="datetime-local"
              id="dataInicio"
              name="dataInicio"
              required
              th:value="*{dataInicio != null ? #temporals.format(dataInicio, 'yyyy-MM-dd''T''HH:mm') : ''}"
            />

            <p
              th:if="${#fields.hasErrors('dataInicio')}"
              th:errors="*{dataInicio}"
              class="text-red-500 text-sm"
            ></p>
          </div>

          <div class="flex flex-col gap-1">
            <label for="dataFim">
              Data de Fim <span class="text-red-500">*</span>
            </label>

            <input
              class="border px-3 py-1.5 rounded-md"
              type="datetime-local"
              id="dataFim"
              name="dataFim"
              required
              th:value="*{dataFim != null ? #temporals.format(dataFim, 'yyyy-MM-dd''T''HH:mm') : ''}"
            />

            <p
              th:if="${#fields.hasErrors('dataFim')}"
              th:errors="*{dataFim}"
              class="text-red-500 text-sm"
            ></p>
          </div>
        </div>

        <div class="col-span-3 grid grid-cols-3 gap-4">
          <div class="flex flex-col gap-1">
            <label for="preco">
              Preço
              <span class="text-red-500">*</span>
            </label>

            <input
              class="border px-3 py-1.5 rounded-md"
              type="number"
              step="0.01"
              id="preco"
              name="preco"
              placeholder="Digite o preço (ex: 50.00)"
              required
              th:value="*{preco}"
            />

            <p
              th:if="${#fields.hasErrors('preco')}"
              th:errors="*{preco}"
              class="text-red-500 text-sm"
            ></p>
          </div>

          <div class="flex flex-col gap-1">
            <label for="idadeMinima"> Idade Mínima </label>

            <select
              class="border px-3 py-1.5 rounded-md"
              id="idadeMinima"
              name="idadeMinima"
            >
              <option value="">Livre</option>
              <option value="12" th:selected="${evento.idadeMinima == 12}">
                12 anos
              </option>
              <option value="14" th:selected="${evento.idadeMinima == 14}">
                14 anos
              </option>
              <option value="16" th:selected="${evento.idadeMinima == 16}">
                16 anos
              </option>
              <option value="18" th:selected="${evento.idadeMinima == 18}">
                18 anos
              </option>
              <option value="21" th:selected="${evento.idadeMinima == 21}">
                21 anos
              </option>
            </select>

            <p
              th:if="${#fields.hasErrors('idadeMinima')}"
              th:errors="*{idadeMinima}"
              class="text-red-500 text-sm"
            ></p>
          </div>

          <div class="flex flex-col gap-1">
            <label for="status">
              Status
              <span class="text-red-500">*</span>
            </label>

            <select
              class="border px-3 py-1.5 rounded-md"
              id="status"
              name="status"
              required
            >
              <option value="">Selecione um status</option>
              <option
                th:each="st : ${statusList}"
                th:value="${st}"
                th:text="${st.displayName}"
                th:selected="${st == evento.status}"
              ></option>
            </select>

            <p
              th:if="${#fields.hasErrors('status')}"
              th:errors="*{status}"
              class="text-red-500 text-sm"
            ></p>
          </div>
        </div>
      </form>

      <div class="grid grid-cols-3 gap-4">
        <button
          class="col-start-2 col-end-3 border border-red-500 text-red-500 text-sm flex justify-center items-center gap-2 hover:bg-red-500 hover:text-white rounded-md px-3 py-2 transition-colors cursor-pointer"
          form="excluir-evento"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-trash-icon lucide-trash size-4"
          >
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
            <path d="M3 6h18" />
            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
          </svg>
          Excluir evento
        </button>

        <button
          type="submit"
          class="col-start-3 col-end-4 h-10 bg-blue-500 px-4 py-1.5 rounded-md text-neutral-100 font-medium transition-colors hover:bg-blue-600 flex items-center justify-center"
          form="atualizar-evento"
        >
          Atualizar
        </button>
      </div>

      <form
        id="excluir-evento"
        class="flex justify-center"
        th:action="@{'/eventos/excluir/' + ${evento.id}}"
      ></form>
    </main>

    <th:block th:replace="fragments/footer :: footer"></th:block>

    <script>
      let selectedFiles = [];
      let midiasExistentes = [];

      // Inicializar com mídias existentes
      document.addEventListener("DOMContentLoaded", function () {
        const previews = document.querySelectorAll(
          "#preview-midias > div[data-midia-id]"
        );
        previews.forEach((preview) => {
          midiasExistentes.push(
            parseInt(preview.getAttribute("data-midia-id"))
          );
        });
      });

      document
        .getElementById("midias")
        .addEventListener("change", function (event) {
          selectedFiles = Array.from(event.target.files);
          renderPreviews();
        });

      function excluirMidiaExistente(button) {
        const container = button.closest("div[data-midia-id]");
        const midiaId = parseInt(container.getAttribute("data-midia-id"));

        // Adicionar à lista de exclusão
        adicionarMidiaParaExcluir(midiaId);

        // Remover do DOM
        container.remove();
      }

      function adicionarMidiaParaExcluir(midiaId) {
        const input = document.getElementById("midiasParaExcluir");
        const valores = input.value ? input.value.split(",").map(Number) : [];
        if (!valores.includes(midiaId)) {
          valores.push(midiaId);
        }
        input.value = valores.join(",");
      }

      function renderPreviews() {
        const preview = document.getElementById("preview-midias");
        // Remove apenas as novas imagens (não as existentes)
        const novasImagens = preview.querySelectorAll(
          "div:not([data-midia-id])"
        );
        novasImagens.forEach((el) => el.remove());

        // Adicionar novas imagens selecionadas
        selectedFiles.forEach((file, index) => {
          const div = document.createElement("div");
          div.className = "border rounded-lg overflow-hidden relative";

          const img = document.createElement("img");
          img.className = "w-full h-full object-cover aspect-square";
          img.alt = "Pré-visualização da mídia";

          const reader = new FileReader();
          reader.onload = function (e) {
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);

          const deleteBtn = document.createElement("button");
          deleteBtn.className =
            "absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600";
          deleteBtn.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x size-3"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>';
          deleteBtn.type = "button";
          deleteBtn.onclick = function (e) {
            e.preventDefault();
            selectedFiles.splice(index, 1);
            renderPreviews();
            updateInputFiles();
          };

          div.appendChild(img);
          div.appendChild(deleteBtn);
          preview.appendChild(div);
        });
      }

      function updateInputFiles() {
        const input = document.getElementById("midias");
        const dt = new DataTransfer();
        selectedFiles.forEach((file) => dt.items.add(file));
        input.files = dt.files;
      }
    </script>
  </body>
</html>
